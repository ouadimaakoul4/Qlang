That's a very comprehensive, single-page web application! The code is mostly well-structured and functional, but the prompt asked me to fix it.
The main issue is that the code structure separates display logic (HTML/CSS) from the data filtering/search logic (JavaScript), and the filtering functionality is incomplete and disconnected. Specifically:
 * Filtering is not implemented: The HTML elements for filtering (#domainFilter and #confidenceFilter) are present but completely unused in the provided JavaScript logic (showByCategory and askQLang).
 * showByCategory issue: This function shows laws for a category, but it doesn't correctly apply the filter logic from the hidden filter controls. The filter controls are shown but don't do anything after a category is selected.
 * No dedicated filterLaws function: A reusable function to apply both domain text search and confidence level filtering is missing.
 * marked.parse issue: The marked.parse(responseMarkdown) call within askQLang is the correct way to convert markdown to HTML, but the code needs the marked library's setup to be more robust, especially since it's an asynchronous library.
 * Small bug in showLibrary: The showLibrary function doesn't use the createLawCard function, leading to code duplication and making it harder to maintain.
Here is the fixed and enhanced code, primarily by adding the filtering logic and integrating it into the showLibrary and showByCategory functions, as well as refining the primary function calls.
Fixed and Enhanced HTML/JavaScript Code
I have added a new, unified function, filterAndRenderLaws, to handle all display and filtering logic, and I've wired up the filter elements (#domainFilter and #confidenceFilter) to this function. I also ensured that marked is correctly called and that showLibrary reuses the createLawCard utility.
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLang v1.0 ‚Äî Library of Universal Laws</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script> 
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary: #0c2461;
            --secondary: #1e3799;
            --accent: #ff6b6b;
            --light: rgba(255, 255, 255, 0.1);
            --lighter: rgba(255, 255, 255, 0.05);
            --text: white;
            --card-bg: white;
            --card-text: #333;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            background: var(--light);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4a69bd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .search-container {
            flex: 1;
            min-width: 300px;
        }
        
        input[type="text"] { /* Specificity for the text input to not conflict with the range */
            width: 100%; 
            padding: 15px; 
            margin-bottom: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        /* Added style for the range input for better visibility */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            margin: 10px 0;
            cursor: pointer;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        button { 
            padding: 15px 25px; 
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }
        
        button:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        button.secondary {
            background: #4a69bd;
        }
        
        button.secondary:hover {
            background: #3c5aa8;
        }
        
        #response { 
            background: var(--card-bg);
            color: var(--card-text);
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            min-height: 100px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        #response h3 {
            color: var(--secondary); /* Making headings in the response stand out */
        }
        
        .library-section {
            background: var(--lighter);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .library-section h3 {
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffd700;
        }
        
        .law-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
            transition: transform 0.3s;
        }
        
        .law-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .law-card h4 {
            margin-bottom: 10px;
            color: #ffd700;
        }
        
        .domain-tag {
            display: inline-block;
            background: #4a69bd;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin: 5px 5px 5px 0;
            color: white;
        }
        
        .confidence-bar {
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .confidence-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }
        
        .math-formula {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 3px solid #4a69bd;
            color: #333;
            overflow-x: auto;
        }
        
        .latex-container {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 8px;
            overflow-x: auto;
        }
        
        .law-meta {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-top: 15px;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .category-badge {
            display: inline-block;
            padding: 3px 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 20px 0;
            text-align: center;
        }
        
        .stat-card {
            background: var(--lighter);
            padding: 15px;
            border-radius: 10px;
            margin: 10px;
            flex: 1;
            min-width: 150px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Style for the filter label for better contrast */
        .filters label {
            display: block;
            margin-top: 5px;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåå QLang ‚Äî Library of Universal Laws</h1>
            <p>Explore cosmic knowledge through the fundamental laws of the universe</p>
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="law-count">0</div>
                <div class="stat-label">Universal Laws</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="category-count">0</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="domain-count">0</div>
                <div class="stat-label">Domains</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="search-container">
                <input type="text" id="question" placeholder="Ask your cosmic question...">
            </div>
            
            <div class="button-group">
                <button onclick="showLibrary('fundamental_physics')" class="secondary">‚öõÔ∏è Physics</button>
                <button onclick="showLibrary('cosmology')" class="secondary">üåå Cosmology</button>
                <button onclick="showLibrary('information')" class="secondary">üí° Information</button>
            </div>

            <div class="button-group">
                <button onclick="askQLang()">‚ú® Query the Universe</button>
                <button onclick="showLibrary()" class="secondary">üìö View Library</button>
                <button onclick="showRandomLaw()" class="secondary">üé≤ Random Law</button>
            </div>
        </div>

        <div class="filters" style="margin: 15px 0; display: none;" id="filters">
            <input type="text" id="domainFilter" placeholder="Filter by domain (quantum, relativity...)" style="margin-bottom: 10px;" oninput="filterAndRenderLaws()">
            <input type="range" id="confidenceFilter" min="0" max="100" value="0" style="width: 100%;" oninput="document.getElementById('confidenceValue').textContent = this.value + '%'; filterAndRenderLaws()">
            <label for="confidenceFilter">Minimum Confidence: <span id="confidenceValue">0%</span></label>
            <input type="hidden" id="currentCategory" value=""> </div>
        
        <div id="response">
            <p>Welcome to QLang! Explore the fundamental laws that govern our universe.</p>
        </div>
        
        <div class="footer">
            <p>QLang v1.0 ‚Äî A comprehensive library of universal laws spanning physics, cosmology, information theory, and more</p>
        </div>
    </div>

    <script>
        // ==================== LIBRARY OF UNIVERSAL LAWS (UNCHANGED) ====================
        const universalLaws = {
            // === FUNDAMENTAL PHYSICS ===
            "thermodynamics_2": {
                "name": "Second Law of Thermodynamics",
                "category": "fundamental_physics",
                "domains": ["thermodynamics", "entropy", "time_arrow"],
                "statement": "The entropy of an isolated system can only increase or remain constant",
                "statement_latex": "\\Delta S \\geq 0",
                "formulation": "In any natural process, the total entropy of the universe increases",
                "implications": [
                    "Irreversible time arrow",
                    "Impossibility of perpetual motion",
                    "Heat death of the universe as final state"
                ],
                "proofs": [
                    "Calorimetry experiments",
                    "Real heat engines",
                    "Statistical foundations (Boltzmann)"
                ],
                "limitations": "Open systems and far from equilibrium",
                "confidence": 0.99,
                "discovery_date": "1850",
                "discoverers": ["Rudolf Clausius", "William Thomson"],
                "revolutions": ["thermodynamics", "cosmology"]
            },

            "noether_theorem": {
                "name": "Noether's Theorem",
                "category": "fundamental_physics",
                "domains": ["symmetry", "conservation", "mathematics"],
                "statement": "Every differentiable symmetry of a physical system corresponds to a conservation law",
                "statement_latex": null,
                "formulation": "Continuous symmetries imply conserved quantities",
                "implications": [
                    "Time symmetry ‚Üí energy conservation",
                    "Space symmetry ‚Üí momentum conservation",
                    "Rotation symmetry ‚Üí angular momentum conservation"
                ],
                "confidence": 0.99,
                "discovery_date": "1918",
                "discoverers": ["Emmy Noether"]
            },

            "quantum_superposition": {
                "name": "Quantum Superposition Principle",
                "category": "fundamental_physics", 
                "domains": ["quantum", "superposition", "wave_function"],
                "statement": "A quantum system can exist in multiple states simultaneously until measured",
                "statement_latex": "|\\psi\\rangle = \\sum c_i |\\phi_i\\rangle",
                "formulation": "Wave function as linear combination of basis states",
                "implications": [
                    "Quantum computing advantage",
                    "Double-slit interference",
                    "Schr√∂dinger's cat paradox"
                ],
                "confidence": 0.98,
                "discovery_date": "1926",
                "discoverers": ["Erwin Schr√∂dinger", "Paul Dirac"]
            },

            "quantum_entanglement": {
                "name": "Quantum Entanglement Principle",
                "category": "fundamental_physics",
                "domains": ["quantum", "entanglement", "nonlocality", "correlation"],
                "statement": "Quantum systems can become entangled such that the state of one particle instantly influences another, regardless of distance",
                "statement_latex": "|\\Psi\\rangle = \\frac{1}{\\sqrt{2}}(|0\\rangle_A|1\\rangle_B - |1\\rangle_A|0\\rangle_B)",
                "formulation": "Entangled particles share a single quantum state described by a non-separable wave function",
                "implications": [
                    "Quantum non-locality",
                    "Violation of Bell inequalities", 
                    "Quantum teleportation protocols",
                    "Quantum computing advantage",
                    "Fundamental challenge to local realism"
                ],
                "proofs": [
                    "Aspect experiments (1980s)",
                    "Violation of Bell's inequality",
                    "Quantum teleportation demonstrations",
                    "Quantum cryptography systems"
                ],
                "limitations": "No faster-than-light communication possible",
                "confidence": 0.98,
                "discovery_date": "1935",
                "discoverers": ["Albert Einstein", "Boris Podolsky", "Nathan Rosen"],
                "revolutions": ["quantum_information", "foundations_of_physics"]
            },

            "bell_inequality": {
                "name": "Bell's Theorem and Inequality",
                "category": "fundamental_physics", 
                "domains": ["quantum", "foundations", "nonlocality", "entanglement"],
                "statement": "No local hidden variable theory can reproduce all predictions of quantum mechanics",
                "statement_latex": "|E(a,b) - E(a,b')| + |E(a',b) + E(a',b')| \\leq 2",
                "formulation": "Mathematical inequality that distinguishes between local hidden variable theories and quantum mechanics",
                "implications": [
                    "Quantum mechanics is inherently non-local",
                    "Reality is either non-local or contextual",
                    "Experimental test of quantum foundations",
                    "No complete local deterministic theory possible"
                ],
                "proofs": [
                    "Aspect experiments (1982)",
                    "Loophole-free Bell tests (2015+)",
                    "Consistent violation of inequality in experiments"
                ],
                "confidence": 0.97,
                "discovery_date": "1964",
                "discoverers": ["John Stewart Bell"],
                "revolutions": ["quantum_foundations"]
            },

            "gauge_symmetry": {
                "name": "Gauge Symmetry Principle",
                "category": "fundamental_physics",
                "domains": ["quantum_field_theory", "symmetry", "forces", "standard_model"],
                "statement": "Fundamental forces arise from local gauge symmetries",
                "statement_latex": "\\mathcal{L} = \\bar{\\psi}(i\\gamma^\\mu D_\\mu - m)\\psi - \\frac{1}{4}F_{\\mu\\nu}F^{\\mu\\nu}",
                "formulation": "Requiring Lagrangian invariance under local symmetry transformations necessitates the introduction of gauge fields",
                "implications": [
                    "Unification of forces through symmetry principles",
                    "Prediction of force-carrying particles (gauge bosons)",
                    "Foundation of the Standard Model",
                    "Charge conservation as consequence of symmetry"
                ],
                "proofs": [
                    "Success of quantum electrodynamics (QED)",
                    "Prediction and discovery of W and Z bosons",
                    "Accuracy of Standard Model predictions",
                    "Experimental verification of gauge theories"
                ],
                "confidence": 0.97,
                "discovery_date": "1954",
                "discoverers": ["Chen Ning Yang", "Robert Mills"],
                "revolutions": ["particle_physics", "quantum_field_theory"]
            },

            "general_relativity": {
                "name": "General Relativity",
                "category": "fundamental_physics",
                "domains": ["gravitation", "space_time", "cosmology"],
                "statement": "Matter and energy curve spacetime, and this curvature dictates motion.",
                "statement_latex": "G_{\\mu\\nu} = \\frac{8\\pi G}{c^4} T_{\\mu\\nu}",
                "formulation": "Einstein's equation relating geometry and material content.",
                "implications": [
                    "Light deflection by massive bodies",
                    "Gravitational waves",
                    "Cosmic expansion",
                    "Black holes"
                ],
                "proofs": [
                    "Stellar light deflection during solar eclipse (1919)",
                    "Gravitational redshift experiments",
                    "Detection of gravitational waves (LIGO, 2015)"
                ],
                "limitations": "Breaks down at quantum scales or singularities.",
                "confidence": 0.98,
                "discovery_date": "1915",
                "discoverers": ["Albert Einstein"],
                "revolutions": ["gravitation", "cosmology"]
            },

            "quantum_mechanics": {
                "name": "Principles of Quantum Mechanics",
                "category": "fundamental_physics",
                "domains": ["quantum", "uncertainty", "superposition"],
                "statement": "System described by a wave function, unitary evolution, probabilistic measurement",
                "statement_latex": "i\\hbar\\frac{\\partial}{\\partial t}\\Psi = \\hat{H}\\Psi",
                "formulation": "Schr√∂dinger equation describing temporal evolution",
                "implications": [
                    "Wave-particle duality",
                    "Quantum entanglement",
                    "Uncertainty principle",
                    "Tunnel effect"
                ],
                "proofs": [
                    "Stern-Gerlach experiment",
                    "Interferences with individual particles",
                    "Quantum computers"
                ],
                "confidence": 0.99,
                "discovery_date": "1925-1927",
                "discoverers": ["Heisenberg", "Schr√∂dinger", "Dirac", "Bohr"]
            },

            "mass_energy_equivalence": {
                "name": "Mass-Energy Equivalence",
                "category": "fundamental_physics",
                "domains": ["relativity", "energy", "mass"],
                "statement": "Mass and energy are equivalent and convertible",
                "statement_latex": "E = mc^2",
                "implications": [
                    "Nuclear energy",
                    "Particle creation and annihilation",
                    "Spacetime curvature by energy"
                ],
                "confidence": 0.99,
                "discovery_date": "1905",
                "discoverers": ["Albert Einstein"]
            },

            "heisenberg_uncertainty": {
                "name": "Heisenberg Uncertainty Principle",
                "category": "fundamental_physics",
                "domains": ["quantum", "uncertainty", "measurement"],
                "statement": "Impossibility of simultaneously knowing with precision certain pairs of properties",
                "statement_latex": "\\Delta x \\Delta p \\geq \\frac{\\hbar}{2}",
                "implications": [
                    "Fundamental measurement limits",
                    "Probabilistic nature of quantum reality",
                    "Zero-point energy"
                ],
                "confidence": 0.98,
                "discovery_date": "1927",
                "discoverers": ["Werner Heisenberg"]
            },

            "newtons_third_law": {
                "name": "Newton's Third Law of Motion",
                "category": "fundamental_physics",
                "domains": ["mechanics", "force", "interaction"],
                "statement": "For every action, there is an equal and opposite reaction",
                "statement_latex": "\\vec{F}_{12} = -\\vec{F}_{21}",
                "formulation": "The force exerted by object 1 on object 2 is equal in magnitude and opposite in direction to the force exerted by object 2 on object 1",
                "implications": [
                    "Conservation of momentum",
                    "Reciprocity in physical interactions",
                    "Rocket propulsion mechanics"
                ],
                "proofs": [
                    "Experimental observations of collisions",
                    "Rocket launch dynamics",
                    "Balance of forces in static systems"
                ],
                "confidence": 0.99,
                "discovery_date": "1687",
                "discoverers": ["Isaac Newton"],
                "revolutions": ["classical_mechanics"]
            },

            "pauli_exclusion_principle": {
                "name": "Pauli Exclusion Principle",
                "category": "fundamental_physics",
                "domains": ["quantum", "matter", "fermions"],
                "statement": "No two fermions can occupy the same quantum state simultaneously",
                "statement_latex": null,
                "formulation": "Fermions (e.g., electrons) obey antisymmetric wave functions, preventing identical quantum states",
                "implications": [
                    "Structure of atoms and electron shells",
                    "Stability of matter",
                    "Behavior of neutron stars and white dwarfs"
                ],
                "proofs": [
                    "Atomic spectra",
                    "Periodic table structure",
                    "Degenerate matter in astrophysics"
                ],
                "confidence": 0.98,
                "discovery_date": "1925",
                "discoverers": ["Wolfgang Pauli"],
                "revolutions": ["quantum_mechanics"]
            },

            "newtons_first_law": {
                "name": "Newton's First Law of Motion",
                "category": "fundamental_physics",
                "domains": ["mechanics", "force"],
                "statement": "A body remains at rest or in uniform motion unless acted upon by a force",
                "statement_latex": "\\vec{F} = 0 \\implies \\vec{a} = 0",
                "formulation": "Objects maintain their state of motion in the absence of net external forces",
                "implications": [
                    "Foundation of inertia",
                    "Conservation of momentum",
                    "Reference frames"
                ],
                "proofs": [
                    "Galilean experiments",
                    "Motion of planets",
                    "Modern dynamics"
                ],
                "confidence": 0.99,
                "discovery_date": "1687",
                "discoverers": ["Isaac Newton"],
                "revolutions": ["classical_mechanics"]
            },

            "born_rule": {
                "name": "Born Rule",
                "category": "fundamental_physics",
                "domains": ["quantum", "probability", "measurement"],
                "statement": "The probability of a quantum measurement outcome is the square of the wave function amplitude",
                "statement_latex": "P(x) = |\\psi(x)|^2",
                "formulation": "Measurement probabilities are derived from the wave function",
                "implications": [
                    "Probabilistic nature of quantum mechanics",
                    "Interpretation of wave function",
                    "Quantum measurement problem"
                ],
                "proofs": [
                    "Double-slit experiment",
                    "Quantum state tomography",
                    "Photon detection"
                ],
                "confidence": 0.98,
                "discovery_date": "1926",
                "discoverers": ["Max Born"],
                "revolutions": ["quantum_mechanics"]
            },

            "conservation_energy": {
                "name": "Conservation of Energy",
                "category": "fundamental_physics",
                "domains": ["energy", "symmetry", "thermodynamics"],
                "statement": "Energy cannot be created or destroyed, only transformed",
                "statement_latex": "\\frac{dE}{dt} = 0",
                "formulation": "Total energy in an isolated system remains constant over time",
                "implications": [
                    "No perpetual motion machines",
                    "Energy transformation efficiency limits",
                    "Time translation symmetry"
                ],
                "proofs": [
                    "Noether's theorem",
                    "Calorimetry experiments",
                    "Mechanical equivalent of heat"
                ],
                "confidence": 0.99,
                "discovery_date": "1842",
                "discoverers": ["Julius von Mayer", "James Joule", "Hermann von Helmholtz"],
                "revolutions": ["thermodynamics"]
            },

            "conservation_momentum": {
                "name": "Conservation of Momentum",
                "category": "fundamental_physics", 
                "domains": ["mechanics", "symmetry", "collisions"],
                "statement": "Total momentum of an isolated system remains constant",
                "statement_latex": "\\frac{d\\vec{p}}{dt} = 0",
                "formulation": "In the absence of external forces, momentum is conserved",
                "implications": [
                    "Rocket propulsion",
                    "Collision analysis",
                    "Space translation symmetry"
                ],
                "proofs": [
                    "Collision experiments",
                    "Noether's theorem",
                    "Astronomical observations"
                ],
                "confidence": 0.99,
                "discovery_date": "1644",
                "discoverers": ["Ren√© Descartes"],
                "revolutions": ["classical_mechanics"]
            },

            "maxwell_equations": {
                "name": "Maxwell's Equations",
                "category": "fundamental_physics",
                "domains": ["electromagnetism", "waves", "light"],
                "statement": "Fundamental laws governing electricity, magnetism, and electromagnetic waves",
                "statement_latex": "\\nabla \\cdot \\vec{E} = \\frac{\\rho}{\\epsilon_0}, \\quad \\nabla \\cdot \\vec{B} = 0, \\quad \\nabla \\times \\vec{E} = -\\frac{\\partial \\vec{B}}{\\partial t}, \\quad \\nabla \\times \\vec{B} = \\mu_0\\vec{J} + \\mu_0\\epsilon_0\\frac{\\partial \\vec{E}}{\\partial t}",
                "formulation": "Set of four differential equations describing electromagnetic fields",
                "implications": [
                    "Electromagnetic wave propagation",
                    "Speed of light derivation",
                    "Relativity foundation"
                ],
                "proofs": [
                    "Radio wave generation",
                    "Light as electromagnetic wave",
                    "Modern electronics"
                ],
                "confidence": 0.99,
                "discovery_date": "1861-1862",
                "discoverers": ["James Clerk Maxwell"],
                "revolutions": ["electromagnetism", "relativity"]
            },

            "special_relativity": {
                "name": "Special Relativity",
                "category": "fundamental_physics",
                "domains": ["relativity", "space_time", "motion"],
                "statement": "Laws of physics are identical in all inertial frames, and light speed is constant",
                "statement_latex": "ds^2 = -c^2dt^2 + dx^2 + dy^2 + dz^2",
                "formulations": {
                    "postulates": [
                        "Physics laws are same in all inertial frames",
                        "Light speed is constant in vacuum regardless of source motion"
                    ],
                    "effects": [
                        "Time dilation: \\Delta t' = \\frac{\\Delta t}{\\sqrt{1-v^2/c^2}}",
                        "Length contraction: L' = L\\sqrt{1-v^2/c^2}",
                        "Relativistic momentum: p = \\frac{mv}{\\sqrt{1-v^2/c^2}}"
                    ]
                },
                "implications": [
                    "Relativity of simultaneity",
                    "Mass-energy equivalence",
                    "Magnetic fields as relativistic effects"
                ],
                "proofs": [
                    "Muon lifetime experiments",
                    "Particle accelerator results",
                    "GPS satellite timing"
                ],
                "confidence": 0.99,
                "discovery_date": "1905",
                "discoverers": ["Albert Einstein"],
                "revolutions": ["modern_physics"]
            },

            "schrodinger_equation": {
                "name": "Schr√∂dinger Equation",
                "category": "fundamental_physics",
                "domains": ["quantum", "wave_function", "evolution"],
                "statement": "Describes how the quantum state of a physical system changes with time",
                "statement_latex": "i\\hbar\\frac{\\partial}{\\partial t}\\Psi(\\vec{r},t) = \\left[-\\frac{\\hbar^2}{2m}\\nabla^2 + V(\\vec{r},t)\\right]\\Psi(\\vec{r},t)",
                "formulation": "Time-dependent wave equation for quantum systems",
                "implications": [
                    "Quantized energy levels",
                    "Quantum tunneling",
                    "Atomic and molecular structure"
                ],
                "proofs": [
                    "Hydrogen atom spectrum",
                    "Quantum chemistry predictions",
                    "Scanning tunneling microscopy"
                ],
                "confidence": 0.98,
                "discovery_date": "1926",
                "discoverers": ["Erwin Schr√∂dinger"],
                "revolutions": ["quantum_mechanics"]
            },

            "dirac_equation": {
                "name": "Dirac Equation",
                "category": "fundamental_physics",
                "domains": ["quantum", "relativity", "antimatter"],
                "statement": "Relativistic wave equation describing spin-1/2 particles",
                "statement_latex": "(i\\hbar\\gamma^\\mu\\partial_\\mu - mc)\\psi = 0",
                "formulation": "Combines quantum mechanics and special relativity",
                "implications": [
                    "Prediction of antimatter",
                    "Electron spin naturally emerges",
                    "Fine structure of hydrogen"
                ],
                "proofs": [
                    "Discovery of positron (1932)",
                    "Electron magnetic moment",
                    "Relativistic quantum chemistry"
                ],
                "confidence": 0.97,
                "discovery_date": "1928",
                "discoverers": ["Paul Dirac"],
                "revolutions": ["quantum_electrodynamics"]
            },

            // === COSMOLOGY ===
            "hubble_expansion": {
                "name": "Hubble-Lema√Ætre Law",
                "category": "cosmology",
                "domains": ["expansion", "cosmology"],
                "statement": "Galaxies recede at a speed proportional to their distance",
                "statement_latex": "v = H_0 d",
                "implications": [
                    "Expanding universe",
                    "Big Bang as origin",
                    "Finite age of the universe"
                ],
                "confidence": 0.95,
                "discovery_date": "1927-1929",
                "discoverers": ["Georges Lema√Ætre", "Edwin Hubble"]
            },

            "cosmic_microwave_background": {
                "name": "Cosmic Microwave Background Radiation",
                "category": "cosmology",
                "domains": ["cosmology", "big_bang", "radiation", "early_universe"],
                "statement": "The universe is filled with thermal radiation remnant from the early hot, dense phase",
                "statement_latex": "T_{CMB} = 2.72548 \\pm 0.00057\\,K",
                "formulation": "Blackbody spectrum at 2.7K with tiny anisotropies encoding early universe information",
                "implications": [
                    "Strong evidence for Big Bang theory",
                    "Universe was once hot and dense",
                    "Seeds of cosmic structure formation",
                    "Precision measurements of cosmological parameters"
                ],
                "proofs": [
                    "Discovery by Penzias and Wilson (1965)",
                    "COBE satellite blackbody spectrum (1992)",
                    "WMAP and Planck satellite anisotropy maps",
                    "Statistical properties match inflation predictions"
                ],
                "confidence": 0.99,
                "discovery_date": "1965",
                "discoverers": ["Arno Penzias", "Robert Wilson"],
                "revolutions": ["big_bang_cosmology"]
            },

            "dark_energy_dominance": {
                "name": "Dark Energy Dominance",
                "category": "cosmology",
                "domains": ["cosmology", "dark_energy", "expansion"],
                "statement": "Dark energy drives the accelerated expansion of the universe",
                "statement_latex": "\\Omega_{\\Lambda} \\approx 0.68",
                "formulation": "The cosmological constant or equivalent dark energy component dominates the universe's energy density, causing accelerated expansion",
                "implications": [
                    "Accelerated cosmic expansion",
                    "Future dilution of matter",
                    "Ultimate fate of the universe"
                ],
                "proofs": [
                    "Type Ia supernova observations (1998)",
                    "Cosmic microwave background (Planck)",
                    "Large-scale structure surveys"
                ],
                "confidence": 0.94,
                "discovery_date": "1998",
                "discoverers": ["Saul Perlmutter", "Brian Schmidt", "Adam Riess"],
                "revolutions": ["cosmology"]
            },

            "cosmological_principle": {
                "name": "Cosmological Principle",
                "category": "cosmology",
                "domains": ["cosmology", "universe_structure"],
                "statement": "The universe is homogeneous and isotropic on large scales",
                "statement_latex": null,
                "formulation": "No preferred location or direction exists in the universe at cosmological scales",
                "implications": [
                    "Simplified cosmological models",
                    "Uniform cosmic microwave background",
                    "Large-scale structure formation"
                ],
                "proofs": [
                    "CMB isotropy (COBE, Planck)",
                    "Galaxy distribution surveys",
                    "Isotropic expansion rates"
                ],
                "confidence": 0.95,
                "discovery_date": "1930s",
                "discoverers": ["Edwin Hubble", "Georges Lema√Ætre"],
                "revolutions": ["cosmology"]
            },

            "cosmic_inflation": {
                "name": "Cosmic Inflation",
                "category": "cosmology",
                "domains": ["cosmology", "early_universe", "expansion"],
                "statement": "Exponential expansion of the universe in the first fraction of a second",
                "statement_latex": "a(t) \\propto e^{Ht}",
                "formulation": "Rapid accelerated expansion driven by vacuum energy",
                "implications": [
                    "Horizon problem solution",
                    "Flatness problem solution",
                    "Primordial density fluctuations"
                ],
                "proofs": [
                    "CMB temperature anisotropies",
                    "Large-scale structure statistics",
                    "Gravitational wave background (predicted)"
                ],
                "confidence": 0.85,
                "discovery_date": "1980",
                "discoverers": ["Alan Guth", "Andrei Linde", "Paul Steinhardt"],
                "revolutions": ["cosmology"]
            },

            // === ASTROPHYSICS ===
            "stellar_nucleosynthesis": {
                "name": "Stellar Nucleosynthesis",
                "category": "astrophysics",
                "domains": ["astrophysics", "nucleosynthesis", "stars", "elements"],
                "statement": "Stars create chemical elements through nuclear fusion processes",
                "statement_latex": "4^1H \\rightarrow ^4He + 2e^+ + 2\\nu_e + \\gamma",
                "formulation": "Nuclear fusion in stellar cores transforms lighter elements into heavier ones, releasing energy",
                "implications": [
                    "Origin of chemical elements beyond hydrogen and helium",
                    "Stellar energy source and lifetimes",
                    "Galactic chemical evolution",
                    "We are made of stardust"
                ],
                "proofs": [
                    "Stellar spectroscopy showing elemental abundances",
                    "Solar neutrino detection",
                    "Supernova observations creating heavy elements",
                    "Nuclear reaction cross-section measurements"
                ],
                "confidence": 0.98,
                "discovery_date": "1957",
                "discoverers": ["Margaret Burbidge", "Geoffrey Burbidge", "William Fowler", "Fred Hoyle"],
                "revolutions": ["nuclear_astrophysics", "cosmochemistry"]
            },

            // === INFORMATION AND COMPLEXITY ===
            "bekenstein": {
                "name": "Bekenstein Bound",
                "category": "information",
                "domains": ["information", "gravity", "holography"],
                "statement": "Maximum amount of information contained in a region of space",
                "statement_latex": "I \\leq \\frac{2\\pi R E}{\\hbar c \\ln 2}",
                "implications": [
                    "Holographic principle",
                    "Black hole entropy",
                    "Fundamental computational limits"
                ],
                "confidence": 0.90,
                "discovery_date": "1973",
                "discoverers": ["Jacob Bekenstein"]
            },

            "landauer": {
                "name": "Landauer's Principle",
                "category": "information",
                "domains": ["information", "thermodynamics", "computation"],
                "statement": "Erasing one bit of information dissipates at least kT ln(2) of energy",
                "statement_latex": "E \\geq kT \\ln 2",
                "implications": [
                    "Information/entropy link",
                    "Energy limits of computation",
                    "Reversible computers"
                ],
                "confidence": 0.85,
                "discovery_date": "1961",
                "discoverers": ["Rolf Landauer"]
            },

            "shannon_entropy": {
                "name": "Shannon's Information Entropy",
                "category": "information",
                "domains": ["information", "communication", "probability"],
                "statement": "The entropy of a message quantifies its information content or uncertainty",
                "statement_latex": "H(X) = -\\sum_{i} p(x_i) \\log p(x_i)",
                "formulation": "Information entropy measures the average amount of information required to describe a random variable",
                "implications": [
                    "Foundation of information theory",
                    "Limits of data compression",
                    "Error correction in communication systems"
                ],
                "proofs": [
                    "Communication channel experiments",
                    "Data compression algorithms",
                    "Error-correcting codes"
                ],
                "confidence": 0.97,
                "discovery_date": "1948",
                "discoverers": ["Claude Shannon"],
                "revolutions": ["information_theory"]
            },

            "church_turing": {
                "name": "Church-Turing Thesis",
                "category": "information",
                "domains": ["computation", "mathematics", "logic"],
                "statement": "Any function that can be computed by an algorithm can be computed by a Turing machine",
                "statement_latex": null,
                "formulation": "Formal definition of effective calculability and computability",
                "implications": [
                    "Universal computation concept",
                    "Limits of algorithmic computation",
                    "Foundation of computer science"
                ],
                "proofs": [
                    "Equivalence of computational models",
                    "Practical implementation in modern computers",
                    "Theoretical computer science developments"
                ],
                "confidence": 0.95,
                "discovery_date": "1936",
                "discoverers": ["Alonzo Church", "Alan Turing"],
                "revolutions": ["computer_science"]
            },

            // === COMPLEX SYSTEMS ===
            "butterfly_effect": {
                "name": "Butterfly Effect (Sensitive Dependence on Initial Conditions)",
                "category": "complex_systems",
                "domains": ["chaos_theory", "nonlinear_dynamics", "predictability"],
                "statement": "In chaotic systems, small differences in initial conditions can lead to vastly different outcomes",
                "statement_latex": "\\delta(t) \\approx \\delta(0) e^{\\lambda t}",
                "formulation": "Exponential divergence of trajectories in phase space characterized by positive Lyapunov exponents",
                "implications": [
                    "Fundamental limits to long-term prediction",
                    "Weather forecasting limitations",
                    "Emergence of patterns from simple rules",
                    "Importance of microscopic details in macroscopic outcomes"
                ],
                "proofs": [
                    "Lorenz's weather model simulations",
                    "Double pendulum experiments",
                    "Fluid turbulence studies",
                    "Planetary orbit stability calculations"
                ],
                "limitations": "Applies primarily to deterministic nonlinear systems",
                "confidence": 0.95,
                "discovery_date": "1963",
                "discoverers": ["Edward Lorenz"],
                "revolutions": ["chaos_theory", "complex_systems"]
            },

            // === NEUROSCIENCE ===
            "hebbian_learning": {
                "name": "Hebb's Rule (Neural Plasticity)",
                "category": "neuroscience",
                "domains": ["neuroscience", "learning", "plasticity", "computation"],
                "statement": "Neurons that fire together, wire together",
                "statement_latex": "\\Delta w_{ij} = \\eta x_i x_j",
                "formulation": "Synaptic strength increases when pre- and post-synaptic neurons are simultaneously active",
                "implications": [
                    "Biological basis of learning and memory",
                    "Formation of neural assemblies",
                    "Unsupervised learning in neural networks",
                    "Cellular mechanism for associative learning"
                ],
                "proofs": [
                    "Long-term potentiation (LTP) experiments",
                    "Neural circuit formation studies",
                    "Computational models of learning",
                    "Brain plasticity research"
                ],
                "confidence": 0.96,
                "discovery_date": "1949",
                "discoverers": ["Donald Hebb"],
                "revolutions": ["computational_neuroscience", "connectionism"]
            },

            // === BIOLOGY AND COMPLEX SYSTEMS ===
            "natural_selection": {
                "name": "Natural Selection",
                "category": "biology",
                "domains": ["evolution", "biology", "complex_systems"],
                "statement": "Traits that confer survival and reproductive advantages propagate in populations",
                "statement_latex": null,
                "formulation": "Differential survival and reproduction of organisms based on heritable traits",
                "implications": [
                    "Evolution of species",
                    "Adaptation to environments",
                    "Biodiversity"
                ],
                "proofs": [
                    "Fossil record transitions",
                    "Antibiotic resistance in bacteria",
                    "Gal√°pagos finch studies"
                ],
                "confidence": 0.96,
                "discovery_date": "1859",
                "discoverers": ["Charles Darwin", "Alfred Russel Wallace"],
                "revolutions": ["evolutionary_biology"]
            },

            // === MATHEMATICS ===
            "bayes_theorem": {
                "name": "Bayes' Theorem",
                "category": "mathematics",
                "domains": ["probability", "statistics", "decision_theory"],
                "statement": "The probability of an event is updated based on new evidence",
                "statement_latex": "P(A|B) = \\frac{P(B|A)P(A)}{P(B)}",
                "formulation": "Relates conditional probabilities to update beliefs with new data",
                "implications": [
                    "Foundation of Bayesian inference",
                    "Machine learning and AI",
                    "Decision-making under uncertainty"
                ],
                "proofs": [
                    "Derived from basic probability axioms",
                    "Applications in statistical modeling",
                    "Success in predictive algorithms"
                ],
                "confidence": 1.0,
                "discovery_date": "1763",
                "discoverers": ["Thomas Bayes"],
                "revolutions": ["statistics", "machine_learning"]
            },

            "godel_incompleteness": {
                "name": "G√∂del's Incompleteness Theorems",
                "category": "mathematics",
                "domains": ["mathematics", "logic", "foundations"],
                "statement": "In any consistent formal system, there are true statements that cannot be proved",
                "statement_latex": null,
                "formulation": "First theorem: Systems containing basic arithmetic are incomplete\nSecond theorem: Such systems cannot prove their own consistency",
                "implications": [
                    "Limits of formal mathematics",
                    "Undecidable problems",
                    "Foundational crisis in mathematics"
                ],
                "proofs": [
                    "G√∂del numbering construction",
                    "Self-referential statements",
                    "Formal logic derivations"
                ],
                "confidence": 1.0,
                "discovery_date": "1931",
                "discoverers": ["Kurt G√∂del"],
                "revolutions": ["mathematical_logic"]
            },

            // === CHEMISTRY ===
            "periodic_law": {
                "name": "Periodic Law",
                "category": "chemistry",
                "domains": ["chemistry", "elements", "periodicity"],
                "statement": "Properties of elements are periodic functions of their atomic numbers",
                "statement_latex": null,
                "formulation": "Elements exhibit repeating patterns in their chemical behavior when arranged by atomic number",
                "implications": [
                    "Periodic table organization",
                    "Prediction of new elements",
                    "Chemical bonding patterns"
                ],
                "proofs": [
                    "Success of periodic table predictions",
                    "Atomic spectroscopy",
                    "Quantum mechanical explanation"
                ],
                "confidence": 0.98,
                "discovery_date": "1869",
                "discoverers": ["Dmitri Mendeleev"],
                "revolutions": ["chemistry"]
            }
        };

        // ==================== MATHJAX FUNCTIONS ====================

        // MathJax Configuration (UNCHANGED)
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                tags: 'ams'
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };

        function renderMathJax() {
            if (window.MathJax && window.MathJax.typesetPromise) {
                // Ensure marked.js is done before running MathJax
                MathJax.typesetPromise();
            }
        }

        function formatLatex(latexString) {
            if (!latexString) return '';
            // Clean and format LaTeX for MathJax (UNCHANGED)
            return latexString.replace(/\\\\/g, '\\');
        }

        function createFormulaHTML(latexString, isDisplay = true) {
            if (!latexString) return '';
            const formatted = formatLatex(latexString);
            return isDisplay ? `\\[${formatted}\\]` : `\\(${formatted}\\)`; // Use MathJax delimiters
        }

        // ==================== CORE UTILITIES ====================

        function searchLaws(query) {
            // Functionality is fine, keeping it.
            const results = Object.values(universalLaws).filter(law => 
                law.name.toLowerCase().includes(query.toLowerCase()) ||
                law.statement.toLowerCase().includes(query.toLowerCase()) ||
                law.domains.some(domain => domain.toLowerCase().includes(query.toLowerCase())) ||
                (law.implications && law.implications.some(imp => imp.toLowerCase().includes(query.toLowerCase())))
            );
            return results;
        }

        function createLawCard(law) {
            // Refactored to only include the necessary info for the main library view
            const formula = law.statement_latex ? 
                `<div class="latex-container">${createFormulaHTML(law.statement_latex, true)}</div>` : '';
            
            return `<div class="law-card">
                <h4>${law.name} <span class="category-badge">${law.category.replace(/_/g, ' ')}</span></h4>
                <p><strong>Statement:</strong> ${law.statement}</p>
                ${formula}
                <div>${law.domains.map(d => `<span class="domain-tag">${d}</span>`).join('')}</div>
                <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${law.confidence * 100}%"></div>
                </div>
                <div class="law-meta">
                    <span>Confidence: ${(law.confidence * 100).toFixed(0)}%</span>
                    <span>${law.discovery_date}</span>
                    <span>${Array.isArray(law.discoverers) ? law.discoverers.join(', ') : law.discoverers}</span>
                </div>
            </div>`;
        }
        
        // ==================== NEW/FIXED LOGIC ====================

        function filterLaws(laws, domainQuery, minConfidence) {
            const domainLower = domainQuery.toLowerCase().trim();
            const confidenceThreshold = minConfidence / 100;

            return laws.filter(law => {
                const passesConfidence = law.confidence >= confidenceThreshold;
                
                let passesDomain = true;
                if (domainLower) {
                    passesDomain = law.domains.some(domain => domain.toLowerCase().includes(domainLower));
                }

                return passesConfidence && passesDomain;
            });
        }
        
        function filterAndRenderLaws() {
            const currentCategory = document.getElementById('currentCategory').value;
            const domainFilter = document.getElementById('domainFilter').value;
            const confidenceFilter = parseInt(document.getElementById('confidenceFilter').value);
            const responseDiv = document.getElementById('response');

            // 1. Get all laws or laws for the current category
            let allLaws;
            let categoryTitle = "üìö Library of Universal Laws";
            if (currentCategory) {
                allLaws = Object.values(universalLaws).filter(law => law.category === currentCategory);
                categoryTitle = `<h2>${currentCategory.replace(/_/g, ' ').toUpperCase()} Laws</h2>`;
            } else {
                allLaws = Object.values(universalLaws);
            }

            // 2. Apply Filters
            const filteredLaws = filterLaws(allLaws, domainFilter, confidenceFilter);

            // 3. Group and Render
            const categories = {};
            filteredLaws.forEach(law => {
                if (!categories[law.category]) {
                    categories[law.category] = [];
                }
                categories[law.category].push(law);
            });

            let html = `<h2>${categoryTitle} <span style="font-size: 0.6em; opacity: 0.8;">(${filteredLaws.length} found)</span></h2>`;
            
            if (filteredLaws.length === 0) {
                html += `<p>No laws match your current filters (Category: ${currentCategory || 'All'}, Domain: "${domainFilter}", Min Confidence: ${confidenceFilter}%)</p>`;
            } else {
                for (const [category, laws] of Object.entries(categories)) {
                    const categoryName = category.replace(/_/g, ' ').toUpperCase();
                    html += `<div class="library-section">
                            <h3>${categoryName} (${laws.length} laws)</h3>`;
                    
                    laws.forEach(law => {
                        html += createLawCard(law); // Reusing the utility function
                    });
                    
                    html += `</div>`;
                }
            }

            responseDiv.innerHTML = html;
            
            // 4. Update stats and MathJax
            updateStats();
            setTimeout(renderMathJax, 100);
        }

        function showLibrary(category = null) {
            // Update the hidden category filter and show the filters pane
            document.getElementById('currentCategory').value = category || '';
            document.getElementById('filters').style.display = 'block';

            // Reset the response and re-render with new filters
            document.getElementById('response').innerHTML = '';

            // This single function now handles fetching, filtering, and rendering
            filterAndRenderLaws();
        }

        function updateStats() {
            // Count laws
            document.getElementById('law-count').textContent = Object.keys(universalLaws).length;
            
            // Count categories
            const categories = new Set();
            Object.values(universalLaws).forEach(law => categories.add(law.category));
            document.getElementById('category-count').textContent = categories.size;
            
            // Count domains
            const domains = new Set();
            Object.values(universalLaws).forEach(law => {
                law.domains.forEach(domain => domains.add(domain));
            });
            document.getElementById('domain-count').textContent = domains.size;
        }


        // ==================== MAIN FUNCTIONS (FIXED) ====================

        function getRandomLaws(n) {
            // Functionality is fine, keeping it.
            const keys = Object.keys(universalLaws);
            const result = [];
            const usedKeys = new Set();
            
            while (result.length < n && result.length < keys.length) {
                const randomKey = keys[Math.floor(Math.random() * keys.length)];
                if (!usedKeys.has(randomKey)) {
                    usedKeys.add(randomKey);
                    result.push(universalLaws[randomKey]);
                }
            }
            return result;
        }

        // mapQuestion and generateResponse remain unchanged as they are QLang's core "AI" logic

        function mapQuestion(question) {
            const questionLower = question.toLowerCase();
            let bestScore = 0;
            let bestType = null;

            const questionTypes = {
                "fundamentality_info": {
                    "keywords": ["information", "fundamental", "matter", "bit", "primitive", "computation", "entropy", "holography"],
                    "laws": ["bekenstein", "landauer", "shannon_entropy", "church_turing"],
                    "synthesis_template": "Information appears as a fundamental entity, perhaps more primitive than matter itself, with deep connections to computation and entropy."
                },
                "relativity": {
                    "keywords": ["relativity", "einstein", "space-time", "gravitation", "mass-energy", "spacetime", "curvature", "light speed", "inertial frames"],
                    "laws": ["general_relativity", "mass_energy_equivalence", "special_relativity"],
                    "synthesis_template": "Relativity revolutionizes our understanding of space, time, gravitation, and the fundamental relationship between mass and energy."
                },
                "quantum": {
                    "keywords": ["quantum", "uncertainty", "schr√∂dinger", "heisenberg", "born", "pauli", "superposition", "fermions", "wave function", "dirac", "antimatter", "exclusion"],
                    "laws": ["quantum_mechanics", "heisenberg_uncertainty", "pauli_exclusion_principle", "born_rule", "schrodinger_equation", "dirac_equation", "quantum_entanglement", "bell_inequality", "quantum_superposition"],
                    "synthesis_template": "The quantum world reveals a probabilistic and counter-intuitive reality governed by wave functions, uncertainty, and exotic particle behavior."
                },
                "thermodynamics": {
                    "keywords": ["entropy", "thermodynamics", "disorder", "order", "energy", "heat", "temperature", "conservation", "isolated system"],
                    "laws": ["thermodynamics_2", "landauer", "conservation_energy"],
                    "synthesis_template": "Thermodynamics governs energy transformations, defines the arrow of time, and establishes fundamental limits for physical processes."
                },
                "cosmology": {
                    "keywords": ["universe", "expansion", "big bang", "cosmology", "dark energy", "homogeneous", "isotropic", "inflation", "hubble", "cosmic", "primordial"],
                    "laws": ["hubble_expansion", "general_relativity", "dark_energy_dominance", "cosmological_principle", "cosmic_inflation", "cosmic_microwave_background"],
                    "synthesis_template": "Modern cosmology reveals an expanding universe born from an extreme primordial state, with dark energy driving accelerated expansion."
                },
                "chaos_theory": {
                    "keywords": ["chaos", "butterfly effect", "sensitive dependence", "nonlinear", "unpredictable", "complex systems"],
                    "laws": ["butterfly_effect"],
                    "synthesis_template": "Chaos theory reveals how deterministic systems can produce unpredictable, complex behavior through sensitive dependence on initial conditions."
                },
                "neuroscience": {
                    "keywords": ["neural", "brain", "learning", "plasticity", "hebb", "neurons", "synaptic"],
                    "laws": ["hebbian_learning"],
                    "synthesis_template": "Neural plasticity and learning operate through fundamental rules where co-active neurons strengthen their connections."
                },
                "astrophysics": {
                    "keywords": ["stars", "nucleosynthesis", "elements", "stellar", "fusion", "supernova"],
                    "laws": ["stellar_nucleosynthesis"],
                    "synthesis_template": "Stars serve as cosmic element factories, creating the chemical diversity of the universe through nuclear fusion processes."
                },
                "gauge_theory": {
                    "keywords": ["gauge", "symmetry", "yang-mills", "standard model", "force unification"],
                    "laws": ["gauge_symmetry", "noether_theorem"],
                    "synthesis_template": "Fundamental forces emerge from local gauge symmetries, providing the mathematical foundation for particle physics unification."
                },
                "classical_mechanics": {
                    "keywords": ["newton", "motion", "force", "mechanics", "inertia", "momentum", "conservation", "collisions", "action-reaction"],
                    "laws": ["newtons_third_law", "newtons_first_law", "conservation_momentum"],
                    "synthesis_template": "Classical mechanics governs the motion of macroscopic objects under forces, with conservation laws providing fundamental constraints."
                },
                "electromagnetism": {
                    "keywords": ["electromagnetism", "maxwell", "electric", "magnetic", "fields", "waves", "light", "radiation"],
                    "laws": ["maxwell_equations"],
                    "synthesis_template": "Electromagnetism unifies electricity and magnetism, revealing light as an electromagnetic wave and laying foundations for modern physics."
                },
                "evolution": {
                    "keywords": ["evolution", "natural selection", "darwin", "biology", "adaptation", "species", "reproduction", "survival"],
                    "laws": ["natural_selection"],
                    "synthesis_template": "Natural selection drives the evolution of life through differential survival and reproduction of adapted traits."
                },
                "probability_statistics": {
                    "keywords": ["probability", "bayes", "statistics", "inference", "information", "entropy", "uncertainty", "decision theory"],
                    "laws": ["bayes_theorem", "shannon_entropy"],
                    "synthesis_template": "Probability and statistics provide tools to quantify uncertainty, update beliefs with evidence, and measure information content."
                },
                "mathematics_logic": {
                    "keywords": ["mathematics", "logic", "g√∂del", "incompleteness", "computation", "proof", "foundations"],
                    "laws": ["godel_incompleteness", "church_turing"],
                    "synthesis_template": "Mathematical logic reveals fundamental limits of formal systems and defines the nature of computation and provability."
                },
                "chemistry_matter": {
                    "keywords": ["chemistry", "elements", "periodic", "mendeleev", "atoms", "matter", "structure"],
                    "laws": ["periodic_law"],
                    "synthesis_template": "The periodic law reveals fundamental patterns in elemental properties, organizing matter based on atomic structure."
                },
                "symmetry_conservation": {
                    "keywords": ["symmetry", "conservation", "energy", "momentum", "noether", "invariance"],
                    "laws": ["conservation_energy", "conservation_momentum", "noether_theorem"],
                    "synthesis_template": "Fundamental symmetries in nature give rise to conservation laws that constrain all physical processes."
                }
            };

            for (const [type, data] of Object.entries(questionTypes)) {
                const score = data.keywords.filter(word => 
                    questionLower.includes(word)
                ).length;
                
                if (score > bestScore) {
                    bestScore = score;
                    bestType = type;
                }
            }

            return bestType ? questionTypes[bestType] : null;
        }

        function generateResponse(question) {
            const questionType = mapQuestion(question);
            
            if (!questionType) {
                const randomLaws = getRandomLaws(3);
                return `### üîç No Direct Match

**Question** : "${question}"

No specific category was identified. Here are some relevant universal laws:

${randomLaws.map(law => 
    `- **${law.name}** : ${law.statement}`
).join('\n')}

**Suggestions** : Rephrase using terms like "information","big bang", "cosmology", "dark energy", "homogeneous", "isotropic"  , "relativity", "quantum", "expansion", etc.`;
            }

            const invokedLaws = questionType.laws.map(key => universalLaws[key]);
            const averageConfidence = invokedLaws.reduce((sum, law) => sum + law.confidence, 0) / invokedLaws.length;

            let markdown = `### üåü QLang Analysis

**Question** : "${question}"

**Identified category** : ${questionType.keywords.join(', ')}

**Synthesis** : ${questionType.synthesis_template}

---

## üìú Invoked Universal Laws

`;

            invokedLaws.forEach(law => {
                const formulaHTML = law.statement_latex ? createFormulaHTML(law.statement_latex, true) : '';
                
                // Using markdown for MathJax to be processed by marked.js, then by MathJax
                markdown += `### ${law.name}

**Domain** : ${law.domains.map(d => `\`${d}\``).join(', ')}

**Statement** : ${law.statement}

${formulaHTML ? `**Mathematical formulation** : 

${formulaHTML}

` : ''}

**Implications** : ${law.implications.join('; ')}

**Confidence level** : ${(law.confidence * 100).toFixed(0)}%

---
`;
            });

            markdown += `**Global confidence** : ${(averageConfidence * 100).toFixed(1)}%
**Number of invoked laws** : ${invokedLaws.length}`;

            return markdown;
        }

        async function askQLang() {
            const question = document.getElementById('question').value.trim();
            const responseDiv = document.getElementById('response');
            
            // Hide filters when querying
            document.getElementById('filters').style.display = 'none';

            if (!question) {
                responseDiv.innerHTML = "<p>üå† Please ask a cosmic question.</p>";
                return;
            }

            // First, check for direct matches in the library
            const directMatches = searchLaws(question);
            if (directMatches.length > 0) {
                let html = `<h3>üîç Direct Matches Found</h3>`;
                directMatches.forEach(law => {
                    html += createLawCard(law);
                });
                responseDiv.innerHTML = html;
                setTimeout(renderMathJax, 100);
                return;
            }

            responseDiv.innerHTML = "<p>üåÄ Consulting universal archives...</p>";

            await new Promise(resolve => setTimeout(resolve, 1000));

            try {
                // Ensure marked is available and use marked.parse for safety
                const responseMarkdown = generateResponse(question);
                // Marked.js automatically converts the markdown to HTML
                const responseHTML = marked.parse(responseMarkdown);
                responseDiv.innerHTML = responseHTML;
                // Force MathJax rendering after HTML insertion
                setTimeout(renderMathJax, 100);
            } catch (error) {
                responseDiv.innerHTML = `<p>‚ùå Error in the space-time continuum: ${error.message}</p>`;
            }
        }


        function showRandomLaw() {
            // Hide filters when showing a random law
            document.getElementById('filters').style.display = 'none';

            const laws = Object.values(universalLaws);
            const randomLaw = laws[Math.floor(Math.random() * laws.length)];
            const formula = randomLaw.statement_latex ? 
                `<div class="latex-container">${createFormulaHTML(randomLaw.statement_latex, true)}</div>` : '';
            
            const html = `<div class="law-card">
                <h3>üé≤ Random Law</h3>
                <h4>${randomLaw.name} <span class="category-badge">${randomLaw.category.replace(/_/g, ' ').toUpperCase()}</span></h4>
                <p><strong>Statement:</strong> ${randomLaw.statement}</p>
                ${formula}
                <p><strong>Domain:</strong> ${randomLaw.domains.join(', ')}</p>
                <p><strong>Implications:</strong> ${randomLaw.implications.join('; ')}</p>
                <p><strong>Discoverers:</strong> ${Array.isArray(randomLaw.discoverers) ? randomLaw.discoverers.join(', ') : randomLaw.discoverers}</p>
                <p><strong>Date:</strong> ${randomLaw.discovery_date}</p>
                <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${randomLaw.confidence * 100}%"></div>
                </div>
                <div class="law-meta">
                    <span>Confidence level: ${(randomLaw.confidence * 100).toFixed(0)}%</span>
                </div>
            </div>`;
            
            document.getElementById('response').innerHTML = html;
            setTimeout(renderMathJax, 100);
        }

        // ==================== INITIALIZATION ====================

        function init() {
            // Update initial stats
            updateStats();
            
            // Display library on startup (calls showLibrary with default null category)
            showLibrary();
            
            console.log('QLang initialized with', Object.keys(universalLaws).length, 'universal laws');
        }

        // Initialization on page load
        document.addEventListener('DOMContentLoaded', init);

        // Allow using Enter key
        document.getElementById('question').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askQLang();
            }
        });

        // Focus on question field
        document.getElementById('question').focus();
    </script>
</body>
</html>

